package com.pismo.transactions.infrastructure.adapters.out.persistence;

import com.pismo.transactions.TransactionsApiApplication;
import com.pismo.transactions.domain.model.Account;
import com.pismo.transactions.infrastructure.adapters.out.persistence.entity.AccountEntity;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.data.jpa.test.autoconfigure.DataJpaTest;
import org.springframework.boot.jdbc.test.autoconfigure.AutoConfigureTestDatabase;
import org.springframework.boot.testcontainers.service.connection.ServiceConnection;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.ContextConfiguration;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;

@DataJpaTest(properties = {
        "spring.flyway.enabled=false",
        "spring.jpa.hibernate.ddl-auto=create-drop",
        "spring.jpa.show-sql=true"
})
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Testcontainers
@Import(AccountPersistenceAdapter.class)
@ContextConfiguration(classes = TransactionsApiApplication.class)
class AccountPersistenceAdapterIT {

    @Container
    @ServiceConnection
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15-alpine");

    @Autowired
    private AccountPersistenceAdapter adapter;

    @Autowired
    private SpringDataAccountRepository repository;

    @Test
    @DisplayName("Should save account through adapter and return domain object with ID")
    void shouldSaveAccount() {
        Account account = new Account(null, "98765432100");
        Account savedAccount = adapter.save(account);

        assertNotNull(savedAccount.getAccountId(), "Account ID should be generated by the database");
        assertEquals("98765432100", savedAccount.getDocumentNumber());
    }

    @Test
    @DisplayName("Should find account by ID and map to domain object")
    void shouldFindById() {
        AccountEntity entity = new AccountEntity();
        entity.setDocumentNumber("11122233344");
        AccountEntity persisted = repository.save(entity);

        Optional<Account> found = adapter.findById(persisted.getAccountId());

        assertTrue(found.isPresent());
        assertEquals(persisted.getAccountId(), found.get().getAccountId());
        assertEquals("11122233344", found.get().getDocumentNumber());
    }

    @Test
    @DisplayName("Should return true when document number exists")
    void shouldCheckExistenceByDocumentNumber() {
        String docNumber = "55566677788";
        AccountEntity entity = new AccountEntity();
        entity.setDocumentNumber(docNumber);
        repository.save(entity);

        boolean exists = adapter.existsByDocumentNumber(docNumber);

        assertTrue(exists, "Should return true for existing document number");
    }
}
